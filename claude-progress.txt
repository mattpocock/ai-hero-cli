The idea of this sprint of work is to take each part of this PRD, each PRD item should correspond to a unit test or several unit tests that test whether that feature works correctly. Then you can mark them as passing (true) if you run the tests and they pass.

To do this, you should mock the prompt-service and the git-service. I definitely don't want to be running git on every test. These tests should really just test the business logic.

I've added some examples in cherry-pick.test.ts.

---

## Session 2026-01-01

Added test for PRD: "User is prompted to create branch when on main" (cherry-pick command).

Changes:
- Extracted `runCherryPick` function from cherry-pick.ts for testability
- Added test verifying: when on main, prompts for branch name, creates branch, proceeds w/ cherry-pick
- Fixed unused import (NodeContext) in git-service.ts

PRD item marked as tested=true.

---

## Session 2026-01-01 (cont.)

Added test for PRD: "User runs cherry-pick outside git repo" (cherry-pick error case).

Changes:
- Added test in cherry-pick.test.ts that mocks ensureIsGitRepo to fail with NotAGitRepoError
- Verified runCherryPick propagates NotAGitRepoError with correct path/message

PRD item marked as tested=true.

---

## Session 2026-01-01 (cont. 2)

Added test for PRD: "User runs reset outside git repo" (reset error case).

Changes:
- Extracted `runReset` function from reset.ts for testability (same pattern as cherry-pick)
- Removed duplicate NotAGitRepoError from reset.ts (uses git-service.ts version)
- Created test/reset.test.ts with test for NotAGitRepoError case

PRD item marked as tested=true.

---

## Session 2026-01-01 (cont. 3)

Added test for PRD: "User runs cherry-pick without valid upstream" (cherry-pick error case).

Changes:
- Added test in cherry-pick.test.ts that mocks ensureUpstreamBranchConnected to fail with NoUpstreamFoundError
- Verified runCherryPick propagates NoUpstreamFoundError with helpful message about adding upstream remote

PRD item marked as tested=true.

---

## Session 2026-01-01 (cont. 4)

Added test for PRD: "User attempts cherry-pick from same branch" (cherry-pick error case).

Changes:
- Added test in cherry-pick.test.ts that mocks getCurrentBranch to return target branch name
- Verified runCherryPick fails with InvalidBranchOperationError when user is on target branch
- Import InvalidBranchOperationError from cherry-pick.ts

PRD item marked as tested=true.

---

## Session 2026-01-01 (cont. 5)

Added test for PRD: "User runs reset without valid upstream" (reset error case).

Changes:
- Added test in reset.test.ts that mocks ensureUpstreamBranchConnected to fail with NoUpstreamFoundError
- Verified runReset propagates NoUpstreamFoundError with helpful message about adding upstream remote
- Added NoUpstreamFoundError import to reset.test.ts

PRD item marked as tested=true.

---

## Session 2026-01-01 (cont. 6)

Added test for PRD: "User requests non-existent lesson" (reset error case).

Changes:
- Added test in reset.test.ts that mocks getLogOneline to return commits without the requested lesson ID
- Verified runReset propagates CommitNotFoundError with lessonId and branch
- Added CommitNotFoundError import to reset.test.ts

PRD item marked as tested=true.

---

## Session 2026-01-01 (cont. 7)

Added test for PRD: "Cherry-pick results in merge conflict" (cherry-pick error case).

Changes:
- Added test in cherry-pick.test.ts that mocks cherryPick to fail with CherryPickConflictError
- Verified runCherryPick propagates CherryPickConflictError with range and message
- Added CherryPickConflictError import to cherry-pick.test.ts

PRD item marked as tested=true.

---

## Session 2026-01-01 (cont. 8)

Added test for PRD: "User attempts reset when on target branch" (reset error case).

Changes:
- Added test in reset.test.ts that mocks getCurrentBranch to return target branch name
- Mocks selectResetAction to return "reset-current"
- Verified runReset fails with InvalidBranchOperationError when user is on target branch
- Added InvalidBranchOperationError import to reset.test.ts

PRD item marked as tested=true.

---

## Session 2026-01-01 (cont. 9)

Added test for PRD: "User provides conflicting state flags" (reset error case).

Changes:
- Added test in reset.test.ts that verifies runReset fails when both --problem and --solution flags are provided
- Mocks GitService/PromptService, passes problem=true/solution=true
- Verified InvalidBranchOperationError with message "Cannot use both --problem and --solution flags"

PRD item marked as tested=true.

---

## Session 2026-01-01 (cont. 10)

Added test for PRD: "User uses --demo with state flags" (reset error case).

Changes:
- Added 2 tests in reset.test.ts: --demo with --problem, --demo with --solution
- Both verify runReset fails with InvalidBranchOperationError
- Error message: "Cannot use --demo with --problem or --solution flags"

PRD item marked as tested=true.

---

## Session 2026-01-01 (cont. 11)

Added test for PRD: "User interactively resets to solution state" (reset user-flow).

Changes:
- Added test in reset.test.ts that verifies full happy path:
  - Mocks selectLessonCommit to return lesson 01.02.03
  - Mocks selectProblemOrSolution to return "solution"
  - Mocks selectResetAction to return "reset-current"
  - Mocks getCurrentBranch to return non-main/non-target branch
  - Verifies resetHard called with correct commit SHA (abc1234)

PRD item marked as tested=true.

---

## Session 2026-01-01 (cont. 12)

Added test for PRD: "User resets to problem state (before solution)" (reset user-flow).

Changes:
- Added test in reset.test.ts that verifies problem state path:
  - Mocks selectLessonCommit to return lesson 01.02.03
  - Mocks selectProblemOrSolution to return "problem"
  - Mocks getParentCommit to return parent commit SHA
  - Mocks selectResetAction to return "reset-current"
  - Verifies resetHard called with parent commit SHA (parent123), not solution commit

PRD item marked as tested=true.

---

## Session 2026-01-01 (cont. 13)

Added test for PRD: "User resets to solution using --solution flag" (reset user-flow).

Changes:
- Added test in reset.test.ts that verifies --solution flag behavior:
  - Mocks all required GitService/PromptService methods
  - Passes solution=true flag to runReset
  - Tracks whether selectProblemOrSolution was called (should NOT be)
  - Verifies resetHard called with solution commit SHA (abc1234)
  - Confirms state selection prompt is skipped when --solution flag provided

PRD item marked as tested=true.

---

## Session 2026-01-01 (cont. 14)

Added test for PRD: "User resets to problem using --problem flag" (reset user-flow).

Changes:
- Added test in reset.test.ts that verifies --problem flag behavior:
  - Mocks all required GitService/PromptService methods
  - Passes problem=true flag to runReset
  - Tracks whether selectProblemOrSolution was called (should NOT be)
  - Mocks getParentCommit to return parent123
  - Verifies resetHard called with parent commit SHA (parent123)
  - Confirms state selection prompt is skipped when --problem flag provided

PRD item marked as tested=true.

---

## Session 2026-01-02

Added test for PRD: "User creates new branch from lesson" (reset user-flow).

Changes:
- Added 2 tests in reset.test.ts:
  1. "should create new branch at target commit when user selects create-branch"
     - Mocks selectResetAction to return "create-branch"
     - Mocks inputBranchName to return "matt/lesson-work"
     - Verifies checkoutNewBranchAt called with branch name and solution commit SHA
  2. "should create branch at parent commit when user selects problem state"
     - Same setup but selectProblemOrSolution returns "problem"
     - Verifies checkoutNewBranchAt called with parent commit SHA (problem state)

PRD item marked as tested=true.

---

## Session 2026-01-02 (cont.)

Added test for PRD: "User is forced to create branch when on main" (reset user-flow).

Changes:
- Added 2 tests in reset.test.ts:
  1. "should skip action selection and force create-branch when on main"
     - Mocks getCurrentBranch to return "main"
     - Tracks whether selectResetAction was called (should NOT be)
     - Verifies checkoutNewBranchAt called with correct branch name and solution commit SHA
  2. "should create branch at parent commit when on main and problem state selected"
     - Same setup but selectProblemOrSolution returns "problem"
     - Verifies checkoutNewBranchAt called with parent commit SHA (problem state)

PRD item marked as tested=true.

---

## Session 2026-01-02 (cont. 2)

Added test for PRD: "User is warned about uncommitted changes" (reset user-flow).

Changes:
- Added 3 tests in reset.test.ts:
  1. "should warn about uncommitted changes and proceed when user confirms"
     - Mocks getUncommittedChanges to return { hasUncommittedChanges: true, statusOutput: "..." }
     - Verifies confirmResetWithUncommittedChanges is called
     - Verifies resetHard proceeds after confirmation
  2. "should cancel reset when user declines confirmation"
     - confirmResetWithUncommittedChanges fails with PromptCancelledError
     - Verifies resetHard is NOT called
     - Verifies PromptCancelledError is propagated
  3. "should not prompt for confirmation when no uncommitted changes"
     - hasUncommittedChanges = false
     - Verifies confirmResetWithUncommittedChanges is NOT called
     - Verifies resetHard proceeds directly
- Added PromptCancelledError import to reset.test.ts

PRD item marked as tested=true.

---

## Session 2026-01-02 (cont. 3)

Added test for PRD: "User runs reset in demo mode" (reset user-flow).

Changes:
- Added test in reset.test.ts that verifies demo mode behavior:
  - Mocks all required GitService methods including resetHead, restoreStaged
  - Passes demo=true flag to runReset
  - Tracks whether selectProblemOrSolution was called (should NOT be)
  - Tracks whether selectResetAction was called (should NOT be)
  - Tracks whether getUncommittedChanges was called (should NOT be - demo skips check)
  - Verifies resetHard called with solution commit SHA (abc1234)
  - Verifies resetHead called (undo commit)
  - Verifies restoreStaged called (unstage changes)
- Also marked PRD item "User cancels reset due to uncommitted changes" as tested=true (test already existed from previous session)

PRD items marked as tested=true.

---

## Session 2026-01-02 (cont. 4)

Added test for PRD: "User cancels lesson selection" (cherry-pick user-flow).

Changes:
- Added test in cherry-pick.test.ts that mocks selectLessonCommit to fail with PromptCancelledError
- Verified runCherryPick propagates PromptCancelledError when user presses Ctrl+C
- Added PromptCancelledError import to cherry-pick.test.ts

PRD item marked as tested=true.

---

## Session 2026-01-02 (cont. 5)

Added test for PRD: "User cancels lesson selection" (reset user-flow).

Changes:
- Added test in reset.test.ts that mocks selectLessonCommit to fail with PromptCancelledError
- Verified runReset propagates PromptCancelledError when user presses Ctrl+C
- Mirrors the cherry-pick cancel test for parity between commands

PRD item marked as tested=true.

---

## Session 2026-01-02 (cont. 6)

Added test for PRD: "Branch creation fails during main protection flow" (cherry-pick error).

Changes:
- Added test in cherry-pick.test.ts that mocks checkoutNewBranch to fail with FailedToCreateBranchError
- Test scenario: user is on main, selects lesson, enters existing branch name
- Verified runCherryPick propagates FailedToCreateBranchError with branchName and error message
- Added FailedToCreateBranchError import to cherry-pick.test.ts

PRD item marked as tested=true.

---

## Session 2026-01-02 (cont. 7)

Added test for PRD: "Lesson IDs are normalized to standard format" (reset behavior).

Changes:
- Added normalizeLessonId() function to commit-utils.ts
- Modified selectLessonCommit to normalize user-provided lesson IDs (e.g., "1.1.1" -> "01.01.01")
- Added 2 tests in reset.test.ts:
  1. "should normalize lesson ID 1.1.1 to 01.01.01 and find matching commit"
  2. "should normalize lesson ID with dashes (1-2-3) to 01.02.03"
- Supports both dots (1.1.1) and dashes (1-1-1) as separators

PRD item marked as tested=true.

---

## Session 2026-01-02 (cont. 8)

Added test for PRD: "User tries to create branch that exists" (reset error).

Changes:
- Added test in reset.test.ts that mocks checkoutNewBranchAt to fail with FailedToCreateBranchError
- Test scenario: user selects create-branch, enters name of branch that already exists
- Verified runReset propagates FailedToCreateBranchError with branchName and message
- Added FailedToCreateBranchError to imports in reset.test.ts

PRD item marked as tested=true.

---

## Session 2026-01-02 (cont. 9)

Added test for PRD: "User requests problem state for root commit" (reset error).

Changes:
- Added test in reset.test.ts that mocks getParentCommit to fail with NoParentCommitError
- Test scenario: user runs `ai-hero reset 01.01.01 --problem` on initial commit
- Verified runReset propagates NoParentCommitError with commitSha
- Added NoParentCommitError to imports in reset.test.ts

PRD item marked as tested=true.

---

## Session 2026-01-02 (cont. 10)

Added test for PRD: "User cherry-picks from custom source branch" (cherry-pick user-flow).

Changes:
- Added 2 tests in cherry-pick.test.ts:
  1. "should fetch and use custom branch when --branch option is provided"
     - Verifies ensureUpstreamBranchConnected called with custom branch name
     - Verifies cherry-pick uses commit from custom branch
  2. "should cherry-pick specific lesson from custom branch when ID provided"
     - Verifies custom branch used with direct lesson ID
     - Verifies selectLessonCommit prompt is skipped

PRD item marked as tested=true.
